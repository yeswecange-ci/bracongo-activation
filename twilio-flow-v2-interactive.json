{
  "description": "CAN 2025 Kinshasa - Flow Interactif avec Menu & Pronostics - V2 PRODUCTION",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "next": "check_source",
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": -60,
          "y": -420
        }
      }
    },
    {
      "name": "check_source",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "set_source_direct",
          "event": "noMatch"
        },
        {
          "next": "set_source_affiche",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Affiche",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_AFF_GOMBE,START_AFF_MASINA,START_AFF_LEMBA,START_AFF_BANDA,START_AFF_NGALI"
            }
          ]
        },
        {
          "next": "set_source_pdv",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source PDV",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_PDV_BRACONGO,START_PDV_VODACOM,START_PDV_ORANGE,START_PDV_AIRTEL"
            }
          ]
        },
        {
          "next": "set_source_digital",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Digital",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_FB,START_IG,START_TIKTOK,START_WA_STATUS"
            }
          ]
        },
        {
          "next": "set_source_flyer",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Flyer",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_FLYER_UNI,START_FLYER_RUE,START_FLYER_EVENT"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.message.Body}}",
        "offset": {
          "x": -50,
          "y": -190
        }
      }
    },
    {
      "name": "set_source_affiche",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_scan",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "AFFICHE",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_AFF_', ''}}",
            "key": "source_detail"
          },
          {
            "type": "string",
            "value": "{{trigger.message.From}}",
            "key": "phone_number"
          }
        ],
        "offset": {
          "x": -680,
          "y": 100
        }
      }
    },
    {
      "name": "set_source_pdv",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_scan",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "PDV_PARTENAIRE",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_PDV_', ''}}",
            "key": "source_detail"
          },
          {
            "type": "string",
            "value": "{{trigger.message.From}}",
            "key": "phone_number"
          }
        ],
        "offset": {
          "x": -320,
          "y": 100
        }
      }
    },
    {
      "name": "set_source_digital",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_scan",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "DIGITAL",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_', ''}}",
            "key": "source_detail"
          },
          {
            "type": "string",
            "value": "{{trigger.message.From}}",
            "key": "phone_number"
          }
        ],
        "offset": {
          "x": 40,
          "y": 100
        }
      }
    },
    {
      "name": "set_source_flyer",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_scan",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "FLYER",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_FLYER_', ''}}",
            "key": "source_detail"
          },
          {
            "type": "string",
            "value": "{{trigger.message.From}}",
            "key": "phone_number"
          }
        ],
        "offset": {
          "x": 400,
          "y": 100
        }
      }
    },
    {
      "name": "set_source_direct",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_scan",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "DIRECT",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "SANS_QR",
            "key": "source_detail"
          },
          {
            "type": "string",
            "value": "{{trigger.message.From}}",
            "key": "phone_number"
          }
        ],
        "offset": {
          "x": 760,
          "y": 100
        }
      }
    },
    {
      "name": "http_log_scan",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "http_check_user",
          "event": "success"
        },
        {
          "next": "http_check_user",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 400
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"source_type\": \"{{flow.variables.source_type}}\",\n  \"source_detail\": \"{{flow.variables.source_detail}}\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\",\n  \"status\": \"SCAN\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/scan"
      }
    },
    {
      "name": "http_check_user",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "split_user_exists",
          "event": "success"
        },
        {
          "next": "msg_accueil_nouveau",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 700
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/check-user"
      }
    },
    {
      "name": "split_user_exists",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_accueil_nouveau",
          "event": "noMatch"
        },
        {
          "next": "save_user_info",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "User exists",
              "arguments": [
                "{{widgets.http_check_user.parsed.user_exists}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_check_user.parsed.user_exists}}",
        "offset": {
          "x": 0,
          "y": 1000
        }
      }
    },
    {
      "name": "save_user_info",
      "type": "set-variables",
      "transitions": [
        {
          "next": "msg_menu_principal",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_check_user.parsed.user.name}}",
            "key": "user_name"
          },
          {
            "type": "string",
            "value": "{{widgets.http_check_user.parsed.user.id}}",
            "key": "user_id"
          }
        ],
        "offset": {
          "x": -400,
          "y": 1300
        }
      }
    },
    {
      "name": "msg_menu_principal",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_menu_choice",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_menu",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 1600
        },
        "from": "{{flow.channel.address}}",
        "body": "üëã Salut {{flow.variables.user_name}} !\n\nQue veux-tu faire aujourd'hui ?\n\n1Ô∏è‚É£ Voir les Villages CAN\n2Ô∏è‚É£ Voir les matchs & placer un pronostic\n3Ô∏è‚É£ Me d√©sinscrire\n\nTape 1, 2 ou 3",
        "timeout": "1800"
      }
    },
    {
      "name": "check_menu_choice",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_menu_invalid",
          "event": "noMatch"
        },
        {
          "next": "http_get_villages",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Choice 1 - Villages",
              "arguments": [
                "{{widgets.msg_menu_principal.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "1,un,villages,village"
            }
          ]
        },
        {
          "next": "http_get_matches",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Choice 2 - Matchs",
              "arguments": [
                "{{widgets.msg_menu_principal.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "2,deux,matchs,match,pronostic,pronostics"
            }
          ]
        },
        {
          "next": "msg_confirm_unsubscribe",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Choice 3 - Unsubscribe",
              "arguments": [
                "{{widgets.msg_menu_principal.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "3,trois,desinscription,d√©sinscrire,stop"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_menu_principal.inbound.Body}}",
        "offset": {
          "x": -400,
          "y": 1900
        }
      }
    },
    {
      "name": "msg_menu_invalid",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_menu_choice",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_menu",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -900,
          "y": 2100
        },
        "from": "{{flow.channel.address}}",
        "body": "ü§î Choix invalide.\n\nTape simplement :\n1 = Villages\n2 = Matchs\n3 = D√©sinscription",
        "timeout": "1800"
      }
    },
    {
      "name": "http_get_villages",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "split_has_villages",
          "event": "success"
        },
        {
          "next": "msg_error_api",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1200,
          "y": 2400
        },
        "method": "GET",
        "content_type": "application/x-www-form-urlencoded;charset=utf-8",
        "add_twilio_auth": false,
        "url": "https://wabracongo.ywcdigital.com/api/can/villages"
      }
    },
    {
      "name": "split_has_villages",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_no_villages",
          "event": "noMatch"
        },
        {
          "next": "msg_show_villages",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Has villages",
              "arguments": [
                "{{widgets.http_get_villages.parsed.has_villages}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_get_villages.parsed.has_villages}}",
        "offset": {
          "x": -1200,
          "y": 2700
        }
      }
    },
    {
      "name": "msg_show_villages",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1500,
          "y": 3000
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üèòÔ∏è VILLAGES CAN disponibles :\n\n{% for village in widgets.http_get_villages.parsed.villages %}{{village.number}}. {{village.name}}\n   üìç {{village.address}}\n   üë• {{village.members_count}} membres\n\n{% endfor %}‚ú® Participe et repr√©sente ton village !"
      }
    },
    {
      "name": "msg_no_villages",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -900,
          "y": 3000
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üèòÔ∏è Aucun village disponible pour le moment.\n\nOn te tiendra au courant d√®s qu'ils seront cr√©√©s ! ü¶Å"
      }
    },
    {
      "name": "http_get_matches",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "split_has_matches",
          "event": "success"
        },
        {
          "next": "msg_error_api",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 200,
          "y": 2400
        },
        "method": "GET",
        "content_type": "application/x-www-form-urlencoded;charset=utf-8",
        "add_twilio_auth": false,
        "url": "https://wabracongo.ywcdigital.com/api/can/matches/today"
      }
    },
    {
      "name": "split_has_matches",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_no_matches",
          "event": "noMatch"
        },
        {
          "next": "msg_show_matches",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Has matches",
              "arguments": [
                "{{widgets.http_get_matches.parsed.has_matches}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_get_matches.parsed.has_matches}}",
        "offset": {
          "x": 200,
          "y": 2700
        }
      }
    },
    {
      "name": "msg_show_matches",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_match_selection",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_match",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 500,
          "y": 3000
        },
        "from": "{{flow.channel.address}}",
        "body": "‚öΩ MATCHS D'AUJOURD'HUI :\n\n{% for match in widgets.http_get_matches.parsed.matches %}{{match.number}}. {{match.team_a}} vs {{match.team_b}}\n   üïê {{match.match_time}}\n\n{% endfor %}Sur quel match veux-tu placer ton pronostic ?\n\nTape le num√©ro du match (1, 2, 3...)",
        "timeout": "1800"
      }
    },
    {
      "name": "check_match_selection",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_invalid_match",
          "event": "noMatch"
        },
        {
          "next": "save_selected_match",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Valid match number",
              "arguments": [
                "{{widgets.msg_show_matches.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "1,2,3,4,5,6,7,8,9,10"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_show_matches.inbound.Body}}",
        "offset": {
          "x": 500,
          "y": 3300
        }
      }
    },
    {
      "name": "save_selected_match",
      "type": "set-variables",
      "transitions": [
        {
          "next": "msg_ask_pronostic",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.msg_show_matches.inbound.Body}}",
            "key": "selected_match_number"
          }
        ],
        "offset": {
          "x": 200,
          "y": 3600
        }
      }
    },
    {
      "name": "msg_ask_pronostic",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "validate_pronostic",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_pronostic",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 200,
          "y": 3900
        },
        "from": "{{flow.channel.address}}",
        "body": "üéØ Parfait !\n\nQuel est ton pronostic ?\n\nFormate ta r√©ponse comme √ßa :\nSCORE_A-SCORE_B\n\nExemple : 2-1 ou 0-0",
        "timeout": "1800"
      }
    },
    {
      "name": "validate_pronostic",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_invalid_pronostic",
          "event": "noMatch"
        },
        {
          "next": "parse_pronostic",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Valid score format",
              "arguments": [
                "{{widgets.msg_ask_pronostic.inbound.Body}}"
              ],
              "type": "matches_regex",
              "value": "^[0-9]{1,2}[-][0-9]{1,2}$"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_ask_pronostic.inbound.Body}}",
        "offset": {
          "x": 200,
          "y": 4200
        }
      }
    },
    {
      "name": "parse_pronostic",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_save_pronostic",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.msg_ask_pronostic.inbound.Body | split: '-' | first}}",
            "key": "score_a"
          },
          {
            "type": "string",
            "value": "{{widgets.msg_ask_pronostic.inbound.Body | split: '-' | last}}",
            "key": "score_b"
          }
        ],
        "offset": {
          "x": -100,
          "y": 4500
        }
      }
    },
    {
      "name": "http_save_pronostic",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_pronostic_saved",
          "event": "success"
        },
        {
          "next": "msg_pronostic_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -100,
          "y": 4800
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"match_id\": \"{% assign matches = widgets.http_get_matches.parsed.matches %}{% for match in matches %}{% if match.number == flow.variables.selected_match_number %}{{match.id}}{% endif %}{% endfor %}\",\n  \"score_a\": {{flow.variables.score_a}},\n  \"score_b\": {{flow.variables.score_b}}\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/pronostic"
      }
    },
    {
      "name": "msg_pronostic_saved",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 5100
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ Pronostic enregistr√© !\n\nTon pronostic : {{flow.variables.score_a}}-{{flow.variables.score_b}}\n\nüéÅ Si tu gagnes, tu recevras un cadeau !\n\nBonne chance ! ü¶Å"
      }
    },
    {
      "name": "msg_pronostic_error",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_error",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 200,
          "y": 5100
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ùå Oups ! Impossible d'enregistrer ton pronostic.\n\nLe match a peut-√™tre d√©j√† commenc√©.\n\nR√©essaye avec un autre match ! ü¶Å"
      }
    },
    {
      "name": "msg_invalid_pronostic",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "validate_pronostic",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_pronostic",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 600,
          "y": 4500
        },
        "from": "{{flow.channel.address}}",
        "body": "ü§î Format invalide.\n\nUtilise ce format :\nSCORE_A-SCORE_B\n\nExemple : 2-1 ou 3-0",
        "timeout": "1800"
      }
    },
    {
      "name": "msg_invalid_match",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_match_selection",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_match",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 900,
          "y": 3300
        },
        "from": "{{flow.channel.address}}",
        "body": "ü§î Num√©ro invalide.\n\nTape le num√©ro du match (1, 2, 3...)",
        "timeout": "1800"
      }
    },
    {
      "name": "msg_no_matches",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 900,
          "y": 3000
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚öΩ Aucun match disponible aujourd'hui.\n\nOn te pr√©viendra d√®s qu'il y aura des matchs !\n\nAllez les L√©opards ! ü¶Å"
      }
    },
    {
      "name": "msg_confirm_unsubscribe",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_unsubscribe_confirm",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_menu",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1400,
          "y": 2400
        },
        "from": "{{flow.channel.address}}",
        "body": "‚ö†Ô∏è Es-tu s√ªr(e) de vouloir te d√©sinscrire ?\n\nTu ne recevras plus de messages.\n\nTape OUI pour confirmer ou NON pour annuler.",
        "timeout": "1800"
      }
    },
    {
      "name": "check_unsubscribe_confirm",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_menu_principal",
          "event": "noMatch"
        },
        {
          "next": "http_unsubscribe",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Confirmed",
              "arguments": [
                "{{widgets.msg_confirm_unsubscribe.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,1"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_confirm_unsubscribe.inbound.Body}}",
        "offset": {
          "x": 1400,
          "y": 2700
        }
      }
    },
    {
      "name": "http_unsubscribe",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_unsubscribed",
          "event": "success"
        },
        {
          "next": "msg_unsubscribed",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1100,
          "y": 3000
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/unsubscribe"
      }
    },
    {
      "name": "msg_unsubscribed",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_unsubscribed",
          "event": "sent"
        },
        {
          "next": "end_unsubscribed",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1100,
          "y": 3300
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ Tu es d√©sinscrit(e).\n\nTu ne recevras plus de messages.\n\nMerci d'avoir particip√© !\n\nAllez les L√©opards ! ü¶Å"
      }
    },
    {
      "name": "msg_accueil_nouveau",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_optin",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_accueil",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 600,
          "y": 1300
        },
        "from": "{{flow.channel.address}}",
        "body": "ü¶Å BIENVENUE !\n\nLa CAN arrive √† Kinshasa !\n\nüéÅ Inscris-toi pour :\n‚Üí Gagner des cadeaux\n‚Üí Rejoindre un Village CAN\n‚Üí Participer aux jeux\n\nPartenaires : Bracongo, Vodacom, Orange\n\nüëâ Tape OUI pour t'inscrire",
        "timeout": "3600"
      }
    },
    {
      "name": "check_optin",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_relance_optin",
          "event": "noMatch"
        },
        {
          "next": "http_log_optin",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "OUI accept√©",
              "arguments": [
                "{{widgets.msg_accueil_nouveau.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,Ok,1"
            }
          ]
        },
        {
          "next": "msg_refus",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "NON refus√©",
              "arguments": [
                "{{widgets.msg_accueil_nouveau.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "NON,non,Non,N,n,NO,no,No,0,STOP,stop,Stop"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_accueil_nouveau.inbound.Body}}",
        "offset": {
          "x": 600,
          "y": 1600
        }
      }
    },
    {
      "name": "msg_relance_optin",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_optin_relance",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_relance",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 200,
          "y": 1900
        },
        "from": "{{flow.channel.address}}",
        "body": "ü§î Je n'ai pas compris.\n\nPour t'inscrire et gagner des cadeaux CAN, tape simplement :\n\nüëâ OUI",
        "timeout": "1800"
      }
    },
    {
      "name": "check_optin_relance",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "http_log_abandon",
          "event": "noMatch"
        },
        {
          "next": "http_log_optin",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "OUI accept√© relance",
              "arguments": [
                "{{widgets.msg_relance_optin.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,Ok,1"
            }
          ]
        },
        {
          "next": "msg_refus",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "NON refus√© relance",
              "arguments": [
                "{{widgets.msg_relance_optin.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "NON,non,Non,N,n,NO,no,No,0,STOP,stop,Stop"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_relance_optin.inbound.Body}}",
        "offset": {
          "x": 200,
          "y": 2200
        }
      }
    },
    {
      "name": "http_log_optin",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_demande_nom",
          "event": "success"
        },
        {
          "next": "msg_demande_nom",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1100,
          "y": 1900
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"OPT_IN\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/optin"
      }
    },
    {
      "name": "msg_demande_nom",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "validate_nom",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_nom",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1100,
          "y": 2200
        },
        "from": "{{flow.channel.address}}",
        "body": "Super ! üôå\n\nC'est quoi ton nom ou pseudo ?",
        "timeout": "3600"
      }
    },
    {
      "name": "validate_nom",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "set_nom",
          "event": "noMatch"
        },
        {
          "next": "msg_relance_nom",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Nom trop court",
              "arguments": [
                "{{widgets.msg_demande_nom.inbound.Body}}"
              ],
              "type": "less_than",
              "value": "2"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_demande_nom.inbound.Body}}",
        "offset": {
          "x": 1100,
          "y": 2500
        }
      }
    },
    {
      "name": "msg_relance_nom",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "set_nom_relance",
          "event": "incomingMessage"
        },
        {
          "next": "timeout_nom",
          "event": "timeout"
        },
        {
          "next": "delivery_failed",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1400,
          "y": 2800
        },
        "from": "{{flow.channel.address}}",
        "body": "ü§î Donne-moi au moins 2 lettres !\n\nTon pr√©nom ou pseudo ?",
        "timeout": "1800"
      }
    },
    {
      "name": "set_nom_relance",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_inscription",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.msg_relance_nom.inbound.Body | capitalize}}",
            "key": "user_name"
          }
        ],
        "offset": {
          "x": 1700,
          "y": 3100
        }
      }
    },
    {
      "name": "set_nom",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_inscription",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.msg_demande_nom.inbound.Body | capitalize}}",
            "key": "user_name"
          }
        ],
        "offset": {
          "x": 900,
          "y": 2800
        }
      }
    },
    {
      "name": "http_log_inscription",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_confirmation_inscription",
          "event": "success"
        },
        {
          "next": "msg_confirmation_inscription",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1300,
          "y": 3400
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"name\": \"{{flow.variables.user_name}}\",\n  \"source_type\": \"{{flow.variables.source_type}}\",\n  \"source_detail\": \"{{flow.variables.source_detail}}\",\n  \"status\": \"INSCRIT\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/inscription"
      }
    },
    {
      "name": "msg_confirmation_inscription",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1300,
          "y": 3700
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ C'est fait {{flow.variables.user_name}} !\n\nTu es inscrit(e) pour la CAN ! üéâ\n\nüîú Tu peux maintenant :\n‚Üí Voir les Villages CAN\n‚Üí Voir les matchs & placer des pronostics\n‚Üí D√©couvrir les lots √† gagner\n\nüéÅ √Ä gagner avec nos partenaires :\n‚Ä¢ T-shirts\n‚Ä¢ Boissons\n‚Ä¢ Bons d'achat\n\nReviens nous parler pour acc√©der au menu ! ü¶Å"
      }
    },
    {
      "name": "msg_refus",
      "type": "send-message",
      "transitions": [
        {
          "next": "http_log_refus",
          "event": "sent"
        },
        {
          "next": "end_refus",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1800,
          "y": 1900
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "OK, pas de souci ! üëã\n\nSi tu changes d'avis, reviens nous voir.\n\nAllez les L√©opards ! ü¶Å"
      }
    },
    {
      "name": "http_log_refus",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_refus",
          "event": "success"
        },
        {
          "next": "end_refus",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1800,
          "y": 2200
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"REFUS\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/refus"
      }
    },
    {
      "name": "http_log_abandon",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_abandon",
          "event": "success"
        },
        {
          "next": "msg_abandon",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -200,
          "y": 2500
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"ABANDON_OPTIN\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/abandon"
      }
    },
    {
      "name": "msg_abandon",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_abandon",
          "event": "sent"
        },
        {
          "next": "end_abandon",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -200,
          "y": 2800
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Pas de probl√®me ! üëã\n\nSi tu veux t'inscrire plus tard, envoie juste \"OUI\".\n\nAllez les L√©opards ! ü¶Å"
      }
    },
    {
      "name": "msg_error_api",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_error",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -500,
          "y": 3300
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ùå Oups ! Erreur technique.\n\nR√©essaye dans quelques instants.\n\nMerci ! ü¶Å"
      }
    },
    {
      "name": "timeout_menu",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_timeout",
          "event": "success"
        },
        {
          "next": "end_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1400,
          "y": 2000
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"TIMEOUT_MENU\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/timeout"
      }
    },
    {
      "name": "timeout_accueil",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_timeout",
          "event": "success"
        },
        {
          "next": "end_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -600,
          "y": 1600
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"TIMEOUT_ACCUEIL\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/timeout"
      }
    },
    {
      "name": "timeout_relance",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_timeout",
          "event": "success"
        },
        {
          "next": "end_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -200,
          "y": 2200
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"TIMEOUT_RELANCE\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/timeout"
      }
    },
    {
      "name": "timeout_nom",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_timeout",
          "event": "success"
        },
        {
          "next": "end_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1800,
          "y": 2500
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"TIMEOUT_NOM\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/timeout"
      }
    },
    {
      "name": "timeout_match",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_timeout",
          "event": "success"
        },
        {
          "next": "end_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1200,
          "y": 3300
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"TIMEOUT_MATCH\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/timeout"
      }
    },
    {
      "name": "timeout_pronostic",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_timeout",
          "event": "success"
        },
        {
          "next": "end_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 600,
          "y": 4200
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"TIMEOUT_PRONOSTIC\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/timeout"
      }
    },
    {
      "name": "delivery_failed",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_error",
          "event": "success"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 2200,
          "y": 1600
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"DELIVERY_FAILED\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://wabracongo.ywcdigital.com/api/can/error"
      }
    },
    {
      "name": "end_success",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "SUCCESS",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -700,
          "y": 5400
        }
      }
    },
    {
      "name": "end_refus",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "REFUS",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 1900,
          "y": 2500
        }
      }
    },
    {
      "name": "end_unsubscribed",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "UNSUBSCRIBED",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 1100,
          "y": 3600
        }
      }
    },
    {
      "name": "end_abandon",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "ABANDON",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -200,
          "y": 3100
        }
      }
    },
    {
      "name": "end_timeout",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "TIMEOUT",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -1000,
          "y": 2500
        }
      }
    },
    {
      "name": "end_error",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "ERROR",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 400,
          "y": 5400
        }
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}
